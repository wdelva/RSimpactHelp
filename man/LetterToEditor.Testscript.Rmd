---
title: "LetterToEditor.Testscript"
output: html_document
---


```{r, echo = FALSE, cache = FALSE, message = FALSE}
library(RSimpactCyan)
library(RSimpactHelper)
library(data.table)
library(dplyr)
library(magrittr)
library(exactci)
library(nlme)
library(ggplot2)

V <- c(1e3, 1e4, 1e5, 1e6)
transmission.param.a <- -1.0352239 #-1.3997
transmission.param.b <- -89.339994 #-12.0220
transmission.param.c <- 0.4948478 #0.1649
transmission.param.f1 <- log(5)

trans.hazard <- exp(transmission.param.a +
      transmission.param.b * V^-transmission.param.c +
        transmission.param.f1)
log10(100 * trans.hazard)

agedist.data.frame <- agedistr.creator(shape = 5, scale = 65)
testinput <- input.params.creator(conception.alpha_base = -2,
                                  population.eyecap.fraction = 1,
                                  population.simtime = 20,
                                  population.numwomen = 1000,
                                  population.nummen = 1000,
                                  hivseed.amount = 20,
                                  hivseed.age.min = 15,
                                  hivseed.age.max = 75,
                                  person.agegap.woman.dist.normal.sigma = 1,
                                  person.agegap.man.dist.normal.sigma = 1,
                                  person.eagerness.dist.gamma.b = 50,
                                  formation.hazard.agegapry.gap_factor_woman_exp = -0.5,
                                  formation.hazard.agegapry.gap_factor_man_exp = -0.5,
                                  transmission.param.a = -1.0352239, #-1.3997
                                  transmission.param.b = -89.339994, #-12.0220
                                  transmission.param.c = 0.4948478, #0.1649
                                  transmission.param.f1 = log(5),
                                  transmission.param.f2 = 0,
                                  person.vsp.toacute.x = 10,
                                  person.vsp.toaids.x = 7,
                                  person.vsp.tofinalaids.x = 12
                                  )
testinput <- list()
testinput$transmission.param.f1 <- log(5)
testinput$population.nummen <- 500
testinput$population.numwomen <- 500
testinput$population.simtime <- 30
testinput$syncrefyear.interval <- 1
testinput$conception.alpha_base <- -2
testinput$hivseed.age.min <- 25
testinput$hivseed.age.max <- 50
testinput$person.agegap.man.dist.type <- "normal"
testinput$person.agegap.woman.dist.type <- "normal"
testinput$person.agegap.woman.dist.normal.sigma <- 1
testinput$person.agegap.man.dist.normal.sigma <- 1
testinput$person.agegap.woman.dist.normal.mu <- -4
testinput$person.agegap.man.dist.normal.mu <- -4
testinput$person.eagerness.dist.type <- "gamma"
testinput$person.eagerness.dist.type <- "gamma"
testinput$person.eagerness.dist.gamma.a <- 10
testinput$person.eagerness.dist.gamma.b <- 4
testinput$formation.hazard.agegapry.eagerness_sum <- 0.1
testinput$formation.hazard.type <- "agegapry"
testinput$formation.hazard.agegapry.gap_factor_woman_exp <- -0.5#-0.5
testinput$formation.hazard.agegapry.gap_factor_man_exp <- -0.5#-0.5
testoutput <- simpact.run(configParams = testinput,
                          destDir = "temp",
                          agedist = agedist.data.frame,
                          seed = 1)
datalist.test <- readthedata(testoutput)
transmission.events <- subset(datalist.test$etable, eventname == "transmission")
table(transmission.events$p1gender)
hist(datalist.test$rtable$AgeGap)

times <- 0:30

# Calculating HIV prevalence over time
prev.df <- data.frame(times = times,
                      prevalence.men = NA,
                      prevalence.women = NA,
                      prevalence.all = NA)
row.number <- 1
for (time.point in times){
  prevalence.df <- prevalence.calculator(datalist = datalist.test,
                                         agegroup = c(15, 50),
                                         timepoint = time.point)
  prev.df[row.number, ] <- c(time.point, prevalence.df$pointprevalence)
  row.number <- row.number + 1
}


matplot(x = prev.df$times,
        y = prev.df[, 2:4],
        type = "s")
legend(x = "bottomright",
       col = 1:3,
       lty = rep(1, 4),
       legend = c("Men", "Women", "Both"))


# Calculating age mixing metrics at the end of the simulation
agemix.df <- agedif.metric.calculator(datalist = datalist.test,
                                      agegroup = c(15, 30),
                                      timewindow = 10,
                                      timepoint = 15)

agemix.df

# Calculating HIV incidence over time

#' incidence.df <- incidence.calculator(datalist = datalist, agegroup = c(15, 30), timewindow = c(20, 30))
inc.df <- data.frame(times = NA,
                     incidence.men = NA,
                     incidence.women = NA,
                     incidence.all = NA)
row.number <- 1
for (time.point in times[-length(times)]){
  incidence.df <- incidence.calculator(datalist = datalist.test,
                                       agegroup = c(15, 50),
                                       timewindow = c(time.point, time.point + 1))
  inc.df[row.number, ] <- c(time.point + 1, incidence.df$incidence)
  row.number <- row.number + 1
}

matplot(x = inc.df$times,
        y = inc.df[, 2:4],
        type = "s",
        xlab = "time (years)",
        ylab = "HIV incidence",
        main = "transmission.param.f1 = 0")
legend(x = "bottomright",
       col = 1:3,
       lty = rep(1, 4),
       legend = c("Men", "Women", "Both"))




###
###

testinput <- input.params.creator(conception.alpha_base = -2,
                                  population.eyecap.fraction = 0.4,
                                  population.simtime = 30,
                                  population.numwomen = 1000,
                                  population.nummen = 1000,
                                  hivseed.amount = 20,
                                  hivseed.age.min = 15,
                                  hivseed.age.max = 55,
                                  person.agegap.woman.dist.normal.sigma = 1,
                                  person.agegap.man.dist.normal.sigma = 1,
                                  person.eagerness.dist.gamma.b = 40,
                                  formation.hazard.agegapry.gap_factor_woman_exp = -0.5,
                                  formation.hazard.agegapry.gap_factor_man_exp = -0.5,
                                  transmission.param.f1 = 5,
                                  transmission.param.f2 = 0,
                                  person.vsp.toacute.x = 1,
                                  person.vsp.toaids.x = 1,
                                  person.vsp.tofinalaids.x = 1
                                  )
testoutput <- simpact.run(configParams = testinput,
                          destDir = "temp",
                          agedist = agedist.data.frame,
                          seed = 1)
datalist.test <- readthedata(testoutput)
times <- 0:30

# Calculating HIV incidence over time

#' incidence.df <- incidence.calculator(datalist = datalist, agegroup = c(15, 30), timewindow = c(20, 30))
inc.df <- data.frame(times = NA,
                     incidence.men = NA,
                     incidence.women = NA,
                     incidence.all = NA)
row.number <- 1
for (time.point in times[-length(times)]){
  incidence.df <- incidence.calculator(datalist = datalist.test,
                                       agegroup = c(15, 50),
                                       timewindow = c(time.point, time.point + 1))
  inc.df[row.number, ] <- c(time.point + 1, incidence.df$incidence)
  row.number <- row.number + 1
}

matplot(x = inc.df$times,
        y = inc.df[, 2:4],
        type = "s",
        xlab = "time (years)",
        ylab = "HIV incidence",
        main = "transmission.param.f1 = 5")
legend(x = "bottomright",
       col = 1:3,
       lty = rep(1, 4),
       legend = c("Men", "Women", "Both"))



###
###

testinput <- input.params.creator(conception.alpha_base = -2,
                                  population.eyecap.fraction = 0.4,
                                  population.simtime = 30,
                                  population.numwomen = 1000,
                                  population.nummen = 1000,
                                  hivseed.amount = 20,
                                  hivseed.age.min = 15,
                                  hivseed.age.max = 25,
                                  person.agegap.woman.dist.normal.sigma = 1,
                                  person.agegap.man.dist.normal.sigma = 1,
                                  person.eagerness.dist.gamma.b = 40,
                                  formation.hazard.agegapry.gap_factor_woman_exp = -0.5,
                                  formation.hazard.agegapry.gap_factor_man_exp = -0.5,
                                  transmission.param.f1 = -100,
                                  transmission.param.f2 = 0,
                                  person.vsp.toacute.x = 1,
                                  person.vsp.toaids.x = 1,
                                  person.vsp.tofinalaids.x = 1
                                  )
testoutput <- simpact.run(configParams = testinput,
                          destDir = "temp",
                          agedist = agedist.data.frame,
                          seed = 1)
datalist.test <- readthedata(testoutput)
times <- 0:30

# Calculating HIV incidence over time

#' incidence.df <- incidence.calculator(datalist = datalist, agegroup = c(15, 30), timewindow = c(20, 30))
inc.df <- data.frame(times = times,
                     incidence.men = NA,
                     incidence.women = NA,
                     incidence.all = NA)
row.number <- 1
for (time.point in times[-length(times)]){
  incidence.df <- incidence.calculator(datalist = datalist.test,
                                       agegroup = c(15, 50),
                                       timewindow = c(time.point, time.point + 1))
  inc.df[row.number, ] <- c(time.point + 1, incidence.df$incidence)
  row.number <- row.number + 1
}

matplot(x = inc.df$times,
        y = inc.df[, 2:4],
        type = "s",
        xlab = "time (years)",
        ylab = "HIV incidence",
        main = "transmission.param.f1 = -100")
legend(x = "bottomright",
       col = 1:3,
       lty = rep(1, 4),
       legend = c("Men", "Women", "Both"))

matplot(x = prev.df$times,
        y = prev.df[, 2:4],
        type = "s",
        xlab = "time (years)",
        ylab = "HIV prevalence")
legend(x = "bottomright",
       col = 1:3,
       lty = rep(1, 4),
       legend = c("Men", "Women", "Both"))

agemix.df
hist(datalist.test$rtable$AgeGap)
print(datalist.test$ltable)
nrow(datalist.test$rtable) # Total number of relationships


```

```{r, echo = FALSE, cache = FALSE, message = FALSE}
# library(RSimpactHelper)
# library(data.table)
# library(dplyr)
# library(magrittr)
# datalist.test <- readthedata(testoutput)
# times <- 0:60
# prev.df <- data.frame(times = times,
#                       prevalence.men = NA,
#                       prevalence.women = NA,
#                       prevalence.all = NA)
# row.number <- 1
# for (times in times){
#   prevalence.df <- prevalence.calculator(datalist = datalist.test,
#                                          agegroup = c(15, 50),
#                                          timepoint = times)
#   prev.df[row.number, ] <- c(times, prevalence.df$pointprevalence)
#   row.number <- row.number + 1
# }
# 
# agemix.df <- agedif.metric.calculator(datalist = datalist.test,
#                                       agegroup = c(15, 30),
#                                       timewindow = 10,
#                                       timepoint = 30)
# 
# 
# 
# matplot(x = prev.df$times,
#         y = prev.df[, 2:4],
#         type = "s")
# legend(x = "bottomright",
#        col = 1:3,
#        lty = rep(1, 4),
#        legend = c("Men", "Women", "Both"))
# 
# agemix.df
# hist(datalist.test$rtable$AgeGap)
# print(datalist.test$ltable)
# nrow(datalist.test$rtable) # Total number of relationships
```
