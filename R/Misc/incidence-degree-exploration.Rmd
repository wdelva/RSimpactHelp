---
title: "Incidence-degree-exploration"
author: "Wim Delva"
date: "29 September 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r getready, echo = FALSE, message = FALSE, cache = TRUE}
library(RSimpactCyan)
library(RSimpactHelper)
library(data.table)
library(dplyr)
library(magrittr)
library(exactci)
library(nlme)
library(ggplot2)
# install.packages("readcsvcolumns", repos="http://193.190.10.42/jori/")
library(readcsvcolumns)
library(survival)
library(KMsurv)
library(tidyr)
library(expoTree)
library(sna)
library(intergraph)
library(igraph)
library(lhs)
```


```{r getmodelready, echo=FALSE, message = FALSE, cache = TRUE}
# simpact.set.simulation("simpact-cyan")#("maxart")

agedist.data.frame <- agedistr.creator(shape = 5, scale = 65)

testinput <- list()
testinput$mortality.normal.weibull.shape <- 5
testinput$mortality.normal.weibull.scale <- 65
testinput$mortality.normal.weibull.genderdiff <- 0
testinput$periodiclogging.interval <- 1
testinput$syncrefyear.interval <- 1
testinput$formation.hazard.type <- "agegapry"
testinput$person.eagerness.dist.type <- "gamma"
testinput$person.eagerness.dist.type <- "gamma"
testinput$person.eagerness.dist.gamma.a <- 0.231989836885#0.15 #0.425#3.4#1.7#0.85 #0.1
testinput$person.eagerness.dist.gamma.b <- 45#70#100 #3.5#5#10#20 #170
testinput$person.agegap.man.dist.type <- "normal"
testinput$person.agegap.woman.dist.type <- "normal"
testinput$person.agegap.man.dist.normal.mu <- -5
testinput$person.agegap.woman.dist.normal.mu <- 2.5
testinput$person.agegap.man.dist.normal.sigma <- 1
testinput$person.agegap.woman.dist.normal.sigma <- 1
testinput$formation.hazard.agegapry.numrel_man <- -0.5
testinput$formation.hazard.agegapry.numrel_woman <- -0.5
testinput$formation.hazard.agegapry.gap_factor_man_exp <- -0.35#-0.15# -0.5
testinput$formation.hazard.agegapry.gap_factor_woman_exp <- -0.35#-0.15# -0.5
testinput$formation.hazard.agegapry.gap_factor_man_const <- 0
testinput$formation.hazard.agegapry.gap_factor_woman_const <- 0
testinput$formation.hazard.agegapry.gap_agescale_man <- 0.23
testinput$formation.hazard.agegapry.gap_agescale_woman <- 0.1#0.23
testinput$formation.hazard.agegapry.eagerness_sum <- 0.1
testinput$formation.hazard.agegapry.eagerness_diff <- -0.048#-0.110975
testinput$dissolution.alpha_0 <- -0.52#-0.1 # baseline
testinput$dissolution.alpha_4 <- -0.05 
testinput$debut.debutage <- 14
testinput$population.simtime <- 40
testinput$population.nummen <- 500 #1000 #2000
testinput$population.numwomen <- 500 #1000 #2000
testinput$population.maxevents <- testinput$population.simtime * testinput$population.nummen * 4 # If 4 events happen per person per year, something's wrong.
testinput$population.eyecap.fraction <- 0.2
testinput$hivseed.type <- "amount"
testinput$hivseed.amount <- 20
testinput$hivseed.age.min <- 20
testinput$hivseed.age.max <- 30
testinput$hivseed.time <- 10
testinput$transmission.param.a <- -1.0352239
testinput$transmission.param.b <- -89.339994
testinput$transmission.param.c <- 0.4948478
testinput$transmission.param.f1 <- log(5) # ~1.6 such that the hazard is x 5 in 15 yo
testinput$transmission.param.f2 <- log(log(2.5) / log(5)) / 5
testinput$conception.alpha_base <- -2.35 #-3
testinput$diagnosis.baseline <- -100 # This will result in timing of HIV diagnosis way beyond the simulation period (until this parameter is overwritten when ART is introduced)
testinput$monitoring.cd4.threshold <- 0.01
```

```{r ARTintervention, echo=FALSE, message = FALSE, cache = TRUE}
# Simulation starts in 1977. After 27 years (in 2004), ART is introduced.
art.intro <- list()
art.intro["time"] <- 27
art.intro["diagnosis.baseline"] <- 0 # Reset to zero, from its original value of -100 at the start of the simulatio
art.intro["monitoring.cd4.threshold"] <- 100
art.intro["diagnosis.genderfactor"] <- 2

# Gradual increase in CD4 threshold. in 2007:200. in 2010:350. in 2013:500

art.intro2 <- list()
art.intro2["time"] <- 30
art.intro2["monitoring.cd4.threshold"] <- 200
art.intro2["diagnosis.genderfactor"] <- 1.5

art.intro3 <- list()
art.intro3["time"] <- 33
art.intro3["monitoring.cd4.threshold"] <- 350
art.intro3["diagnosis.genderfactor"] <- 1

art.intro4 <- list()
art.intro4["time"] <- 36
art.intro4["monitoring.cd4.threshold"] <- 500
art.intro4["diagnosis.genderfactor"] <- 0.5

# person.art.accept.threshold.dist.fixed.value

iv <- list(art.intro, art.intro2, art.intro3, art.intro4)

```

### Summary statistics:
1. Population growth (target between 0 and 2% annual growth rate)
2. Median age difference in most recent relationships (target 2-5 years)
3. IQR age difference in most recent relationships (target IQR 2 - 6)
4. HIV prevalence in the window among men 15-25 (target 5% - 10%)
5. HIV prevalence in the window among men 25-50 (target 10% - 30%)
6. Point prevalence of concurrency among the male partners of women 15 <= x < 30 in the window 25 years after HIV introduction (target 5% - 75%)
7. ART coverage among all HIV+ people aged 15-50 (target 15% - 40% in 2011)
8. HIV incidence among women 15 <= x < 30 in the window 20-30 years after HIV introduction (NO targets)
9. % of women who had > 1 partner in the past 12 months (NO targets)



```{r testrun, echo=FALSE, message = FALSE, cache = TRUE}
# testoutput <- simpact.run(configParams = testinput,
#                           destDir = "temp",
#                           agedist = agedist.data.frame,
#                           intervention = iv,
#                           seed = 1)
```

```{r testoutput, echo=TRUE, message = FALSE, cache = TRUE}
test.output <- function(testoutput){
  datalist.test <- readthedata(testoutput)
  
  # 1. Population growth
  growth.rate <- pop.growth.calculator(datalist = datalist.test,
                                       timewindow = c(0, unique(datalist.test$itable$population.simtime)))
  # 2. Median age difference in most recent relationships (target 2-5 years)
  agemix.df <- agemix.df.maker(datalist.test)
  agedifmedtable <- agedif.median(df = agemix.df, agegroup = c(15, 30), timewindow = 1, timepoint = 30)
  median.AD <- agedifmedtable$median[2] # Median age difference as reported by women
  # 3. IQR age difference in most recent relationships (target IQR 2 - 6)
  IQR.AD <- agedifmedtable$Q3[2] - agedifmedtable$Q1[2] # IQR as reported by women
  # 4. HIV prevalence in the window among men 15-25 (target 5% - 10%)
  prev <- prevalence.calculator(datalist = datalist.test,
                                agegroup = c(15, 25),
                                timepoint = 35)
  prev.men.15.25 <- prev$pointprevalence[1] # among men
  # 5. HIV prevalence in the window among men 25-50 (target 10% - 30%)
  prev <- prevalence.calculator(datalist = datalist.test,
                                agegroup = c(25, 50),
                                timepoint = 35)
  prev.men.25.50 <- prev$pointprevalence[1] # among men
  # 6. Point prevalence of concurrency. postsim function to be converted to RSimpactHelper function
  
  # 7. ART coverage among all HIV+ people aged 15-50 (target 15% - 40% in 2011)
  ARTcov <- ART.coverage.calculator(datalist = datalist.test,
                                    agegroup = c(15, 50),
                                    timepoint = 34) # 2011 is 34 years after 1977
  ART.cov.15.50 <- ARTcov$ART.coverage[3] # among men and women
  # 8. HIV incidence among women 15 <= x < 30 in the window 20-30 years after HIV introduction
  inc <- incidence.calculator(datalist = datalist.test,
                              agegroup = c(15, 30),
                              timewindow = c(30, 40))
  incid.wom.15.30 <- inc$incidence[2] # among women
  # NOTE: We may want to also calculate a different type of HIV incidence, more in line with the Harling paper:
  # Where we only accumulate exposure time for the periods that a woman was in (a) relationship(s).
  # For now, this (correct) HIV incidence measure suffices
  
  # 9. % of women who had > 1 partner in the past 12 months
  degree.df <- degree.df.maker(agemix.df,
                               agegroup = c(15, 30),
                               hivstatus = 0,
                               survey.time = 30,
                               window.width = 1,
                               only.new = FALSE)
  frac.degreeGT1.wom.15.30 <- mean(degree.df$Degree > 1)
  # If we want to know % of women who had 0 partners in the past 12 months,
  # We need to compare nrow(degree.df) with the number of 15-30 year old HIV negative women
  # that were alive at the time of the survey
  # allsurveywomen <- dplyr::filter(datalist.test$ptable,
  #               Gender == 1, # Female
  #               TOD > 30, # Still alive at the time of the survey
  #               TOB <=15, # Not younger than 15 at the time of the survey
  #               TOB >0, # Not older than 30 at the time of the survey
  #               InfectTime > 30) # HIV negative at the time of the survey
  # 1 - (nrow(degree.df) / nrow(allsurveywomen))
  
  summStats <- matrix(c(growth.rate, median.AD, IQR.AD, prev.men.15.25, prev.men.25.50, ART.cov.15.50, incid.wom.15.30, frac.degreeGT1.wom.15.30),
                      nrow = 1, dimnames = list(NULL, c("growth.rate", "median.AD", "IQR.AD", "prev.men.15.25", "prev.men.25.50", "ART.cov.15.50", "incid.wom.15.30", "frac.degreeGT1.wom.15.30"))) # 8 summary statistics
  return(summStats)
}
```

```{r errorFunction, echo=TRUE, message = FALSE, cache = TRUE}
# Creating an error function to catch the case when population.maxevents is reached before population.simtime is reached
errFunction <- function(e){
  if (length(grep("MAXEVENTS",e$message)) != 0)
    return(inANDout.test = rep(NA, 8))
  if (length(grep("internal event time",e$message)) != 0)
    return(inANDout.test = rep(NA, 8))
  # Een andere foutmelding dan MAXEVENTS, zorg dat we toch stoppen
  return(inANDout.test = rep(NA, 8)) #stop(e)
}
```

```{r LHSdesign, echo=TRUE, message = FALSE, cache = TRUE}
# Creating the LHS over the 0-1 uniform parameter space
# We are going to vary 6 variables
# 1. person.eagerness.dist.gamma.a (0.1 to 1)
# 2. person.eagerness.dist.gamma.b (10 to 100)
# 3. conception.alpha_base (-4 to -1) (influences population growth rate)
# 4. formation.hazard.agegapry.numrel_man = formation.hazard.agegapry.numrel_woman (-1 to -0.1) (influences concurrency levels)
# 5. formation.hazard.agegapry.eagerness_diff (-0.2 to -0.02) (influences the degree distribution)
# 6. formation.hazard.agegapry.gap_factor_man_exp = formation.hazard.agegapry.gap_factor_woman_exp (-1 to -0.1) (influences variance of age differences)


design.points <- 500
variables <- 6
# On VSC, when each core or node gets its own series of simulations to run, the seed must be set to a different value for each core or node.
set.seed(1)
rlhs <- randomLHS(design.points, variables)

# Creating the LHS dataframe
lhs.df <- data.frame(eagerness.a = rep(NA, design.points), # tunes relationship rate and distribution
                     eagerness.b = rep(NA, design.points), # tunes conception rate) # tunes relationship rate and distribution
                     concept.base = rep(NA, design.points),
                     numrel = rep(NA, design.points),
                     eagerness.diff = rep(NA, design.points),
                     gapfactor.exp = rep(NA, design.points))

lhs.df$eagerness.a <- qunif(rlhs[ , 2], min = 0.1, max = 1)
lhs.df$eagerness.b <- qunif(rlhs[ , 3], min = 10, max = 100)
lhs.df$concept.base <- qunif(rlhs[ , 1], min = -4, max = -1)
lhs.df$numrel <- qunif(rlhs[ , 3], min = -1, max = -0.1)
lhs.df$eagerness.diff <- qunif(rlhs[ , 3], min = -0.2, max = -0.02)
lhs.df$gapfactor.exp <- qunif(rlhs[ , 3], min = -1, max = -0.1)

# Creating a dataframe for input AND output
inANDout.df <- cbind.data.frame(sim.id = 1:design.points,
                                rlhs,
                                lhs.df,
                                growth.rate = rep(NA, design.points),
                                median.AD = rep(NA, design.points),
                                IQR.AD = rep(NA, design.points),
                                prev.men.15.25 = rep(NA, design.points),
                                prev.men.25.50 = rep(NA, design.points),
                                ART.cov.15.50 = rep(NA, design.points),
                                incid.wom.15.30 = rep(NA, design.points),
                                frac.degreeGT1.wom.15.30 = rep(NA, design.points)
                                )
```

```{r simpact4emulation, echo=TRUE, message = FALSE, cache = TRUE}
# Creating a new Simpact4emulation function
simpact4emulation <- function(sim.id, lhs.df, testinput, agedist.data.frame, iv){

  testinput$person.eagerness.dist.gamma.a <- lhs.df$eagerness.a[sim.id] #1
  testinput$person.eagerness.dist.gamma.b <- lhs.df$eagerness.b[sim.id] #2
  testinput$conception.alpha_base <- lhs.df$concept.base[sim.id] #3
  testinput$formation.hazard.agegapry.numrel_man <- lhs.df$numrel[sim.id] #4
  testinput$formation.hazard.agegapry.numrel_woman <- lhs.df$numrel[sim.id] #4
  testinput$formation.hazard.agegapry.eagerness_diff <-lhs.df$eagerness.diff[sim.id] #5
  testinput$formation.hazard.agegapry.gap_factor_man_exp <- lhs.df$gapfactor.exp[sim.id] #6
  testinput$formation.hazard.agegapry.gap_factor_woman_exp <- lhs.df$gapfactor.exp[sim.id] #6

  simpact.seed.id <- sim.id

  testoutput <- simpact.run(configParams = testinput,
                            destDir = "temp",
                            agedist = agedist.data.frame,
                            intervention = iv,
                            seed = simpact.seed.id)

  if (testoutput$simulationtime < testinput$population.simtime)
  {
    # Ik kan op dit moment twee redenen bedenken waarom de simulatie te vroeg zou stoppen
    #  - maximaal aantal events is bereikt, kan op gecheckt worden dmv ret["eventsexecuted"]
    #  - geen events meer, gebeurt bvb als populatie uitsterft.
    if (testoutput$eventsexecuted >= testinput$population.maxevents-1)
    {
      # Ik doe hier een -1 omdat in R getallen standaard voorgesteld worden als floating
      # point getallen, en echte gelijkheden daarmee nogal gevaarlijk zijn.
      stop("MAXEVENTS: Simulation stopped prematurely, max events reached")
    }
    else
    {
      # Misschien moet er in dit geval niet gestopt worden
      stop("Simulation stopped prematurely, probably ran out of events")
    }
  }
  output.stats <- test.output(testoutput)
  return(output.stats)
}

```

```{r simpactTestrun, echo=TRUE, message = FALSE, cache = TRUE}
# Running the simpact4emulation function with error catcher in a loop
for (sim.id in inANDout.df$sim.id){
  out.test <- tryCatch(simpact4emulation(sim.id, lhs.df, testinput, agedist.data.frame, iv), error = errFunction)
  # Inserting the output to the inANDout dataframe
  inANDout.df[sim.id, 14:21] <- as.numeric(out.test)
}
```

```{r saveInputOutput, echo=TRUE, message = FALSE, cache = TRUE}
# Running the simpact4emulation function with error catcher in a loop
save(inANDout.df, agedist.data.frame, testinput, iv, file = "/Users/delvaw/Documents/RSimpactHelper/R/Misc/incidence-degree-exploration.500.RData")
#save(inANDout.df, file = "/Users/delvaw/Documents/RSimpactHelper/R/Misc/incidence-degree-exploration.100.RData")
```

```{r exploreInputOutput, echo=TRUE, message = FALSE, cache = FALSE}
# Running the simpact4emulation function with error catcher in a loop
incidence.degree.exploration.500.loaded <- load(file = "/Users/delvaw/Documents/RSimpactHelper/R/Misc/incidence-degree-exploration.500.RData")
#save(inANDout.df, file = "/Users/delvaw/Documents/RSimpactHelper/R/Misc/incidence-degree-exploration.100.RData")
incidence.degree.exploration.500.loaded
# How many runs gave non-NA output?
nrow(inANDout.df[complete.cases(inANDout.df), ]) # 258

pairs(inANDout.df[, 14:21])
pairs(inANDout.df[, 20:21])
```

### Fitting the emulator to these data
Here we have to insert code blocks from simple.simpact.emulator.R

### Then we rerun Simpact with updated guesses for the model parameters

### Finally we explore the output of the calibrated model

```{r onlyMatches, echo=TRUE, message = FALSE, cache = FALSE}

# 1. Population growth (target between 0 and 2% annual growth rate)
# 2. Median age difference in most recent relationships (target 2-5 years)
# 3. IQR age difference in most recent relationships (target IQR 2 - 6)
# 4. HIV prevalence in the window among men 15-25 (target 5% - 10%)
# 5. HIV prevalence in the window among men 25-50 (target 10% - 30%)
# 6. Point prevalence of concurrency among the male partners of women 15 <= x < 30 in the window 25 years after HIV introduction (target 5% - 75%)
# 7. ART coverage among all HIV+ people aged 15-50 (target 15% - 40% in 2011)

matched.df <- dplyr::filter(inANDout.df,
                            growth.rate >= 0,
                            growth.rate <= 0.04,
                            prev.men.25.50 >= 0.05,
                            prev.men.25.50 <= 0.5,
                            median.AD >= 0,#2,
                            median.AD <= 10,#5,
                            IQR.AD >= 0,#2,
                            IQR.AD <= 20)#6)
                            # median.AD >= 2,
                            # median.AD <= 5,
                            # IQR.AD >= 2,
                            # IQR.AD <= 6,
                            # prev.men.15.25 >= 0.05,
                            # prev.men.15.25 <= 0.1,
                            # prev.men.25.50 >= 0.1,
                            # prev.men.25.50 <= 0.3,
                            # ART.cov.15.50 >= 0.15,
                            # ART.cov.15.50 <= 0.4)

names(matched.df)

matchedplusHarling.df <- rbind(matched.df[, 20:21],
                               c(0.075, 0.013))
matchedplusHarling.df$Harling <- c(rep(0, nrow(matched.df)), 1)

head(matchedplusHarling.df, 30)

pairs(matchedplusHarling.df[, 1:2],
      col = 1+matchedplusHarling.df$Harling)#,
      # xlim = c(0, 1),
      # ylim = c(0, 1))

```


incidence.degree.exploration.500.loaded <- load(file = "/Users/delvaw/Documents/RSimpactHelper/R/Misc/incidence-degree-exploration.500.RData")
nrow(inANDout.df[complete.cases(inANDout.df), ]) # 258
matched.df <- dplyr::filter(inANDout.df,
                            growth.rate >= 0,
                            growth.rate <= 0.04,
                            prev.men.25.50 <= 0.5,
                            median.AD >= 2,
                            median.AD <= 5,
                            IQR.AD >= 2,
                            IQR.AD <= 6)
                            # prev.men.15.25 >= 0.05,
                            # prev.men.15.25 <= 0.1,
                            # prev.men.25.50 >= 0.1,
                            # prev.men.25.50 <= 0.3,
                            # ART.cov.15.50 >= 0.15,
                            # ART.cov.15.50 <= 0.4)
                            
matchedplusHarling.df <- rbind(matched.df[, 20:21],
                               c(0.075, 0.013))
matchedplusHarling.df$Harling <- c(rep(0, nrow(matched.df)), 1)

pairs(matchedplusHarling.df[, 1:2],
      col = 1+matchedplusHarling.df$Harling)
